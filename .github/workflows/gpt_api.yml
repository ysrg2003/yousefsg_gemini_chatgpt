name: ChatGPT Simple API

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø±Ø³Ù„ Ù„Ù€ ChatGPT'
        required: true
        type: string
      request_id:
        description: 'Ø±Ù‚Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ÙØ±ÙŠØ¯'
        required: true
        type: string

jobs:
  run-system:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¥ Download & Inject Assets
        run: |
          echo "ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£ØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø¥ØµØ¯Ø§Ø± v1.0.0..."
          gh release download v1.0.0 -p "vendor_assets.tar.zst"
          
          echo "âš¡ ÙÙƒ Ø§Ù„Ø¶ØºØ· (Zstd)..."
          tar -I zstd -xf vendor_assets.tar.zst -C .
          
          echo "ğŸ”— ØªÙ‡ÙŠØ¦Ø© Ù…Ø®Ø²Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª (Cache)..."
          mkdir -p /home/runner/.cache
          ln -sf $(pwd)/camoufox_cache /home/runner/.cache/camoufox
          
          chmod -R +x /home/runner/.cache/camoufox 2>/dev/null || true
          chmod -R +x browsers/ 2>/dev/null || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Run ChatGPT Automation
        env:
          GPT_COOKIES: ${{ secrets.GPT_COOKIES }}
          PYTHONPATH: ${{ github.workspace }}/python
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/browsers
          CAMOUFOX_CACHE_DIR: /home/runner/.cache/camoufox
        run: |
          echo "ğŸ¬ ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ ChatGPT..."
          # ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„ Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ
          python main_gpt.py "${{ inputs.prompt }}"

      - name: ğŸ“¤ Upload Result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø±Ø¨Ø· Ø§Ø³Ù… Ø§Ù„Ø£Ø±ØªÙŠÙØ§ÙƒØª Ø¨Ø§Ù„Ù€ ID Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
          name: gpt-json-${{ inputs.request_id }}
          path: gpt_result.json
          # ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
          retention-days: 1
